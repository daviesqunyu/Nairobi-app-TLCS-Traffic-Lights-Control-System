<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nairobi CBD Traffic Simulation</title>

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            background-color: #f4f4f4;
        }

        #simulation {
            width: 70%;
            height: 100vh;
        }

        #controls {
            width: 30%;
            padding: 20px;
            background-color: #f7f7f7;
            border-left: 2px solid #333;
        }

        .control-panel {
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            margin: 10px 0;
            background-color: green;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button.stop {
            background-color: red;
        }

        button:hover {
            background-color: #444;
        }

        .traffic-light {
            width: 20px;
            height: 60px;
            background-color: black;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 5px;
        }

        .light {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .red-light {
            background-color: red;
        }

        .green-light {
            background-color: green;
        }

        .off-light {
            background-color: #333;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .loading-note {
            font-size: 14px;
            color: #555;
        }
    </style>
</head>

<body>

    <!-- Simulation Area -->
    <div id="simulation">
        <div id="map"></div>
    </div>

    <!-- Controls Area -->
    <div id="controls">
        <h2>Admin Controls</h2>

        <div class="control-panel">
            <label for="roadSelect">Select Road:</label>
            <select id="roadSelect">
                <option value="kenyatta">Kenyatta Ave</option>
                <option value="moi">Moi Ave</option>
                <option value="university">University Way</option>
            </select>
        </div>

        <div class="control-panel">
            <label for="carCount">Number of Cars:</label>
            <input type="number" id="carCount" min="1" max="50" value="5">
        </div>

        <button onclick="addCars()">Add Cars</button>
        <button onclick="removeCars()">Remove Cars</button>

        <div class="control-panel">
            <button class="stop" onclick="stopCars()">Stop Cars</button>
            <button onclick="continueCars()">Continue Cars</button>
        </div>

        <div class="control-panel">
            <label for="trafficLightControl">Control Traffic Lights:</label>
            <button onclick="toggleTrafficLights()">Toggle Traffic Lights</button>
        </div>
    </div>

    <!-- Leaflet.js -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([-1.286389, 36.817223], 17); // Centered on Nairobi CBD

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- REALâ€‘WORLD ROAD GEOMETRY USING OSRM ROUTING SERVICE ---
        // We only store *endpoints* for each Nairobi CBD road.
        // An external routing engine (OSRM) returns the exact path that follows buildings and corners.
        const roadEndpoints = {
            kenyatta: {
                // Kenyatta Avenue: Uhuru Hwy junction -> Moi Avenue junction
                start: [-1.287000, 36.812900],
                end:   [-1.287300, 36.822500]
            },
            moi: {
                // Moi Avenue: near Tom Mboya St -> Haile Selassie
                start: [-1.282800, 36.821100],
                end:   [-1.289000, 36.821000]
            },
            university: {
                // University Way: Museum Hill side -> Uhuru Hwy side
                start: [-1.282000, 36.814000],
                end:   [-1.287200, 36.819400]
            }
        };

        // Routes resolved from OSRM (arrays of [lat, lng] that really follow the road)
        const roads = {};

        // Fetch a driving route polyline for each road from the free OSRM server.
        // This uses real OpenStreetMap data for Nairobi, so the lines do NOT cut across buildings.
        function loadRoadRoute(roadKey) {
            const { start, end } = roadEndpoints[roadKey];
            const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;

            fetch(url)
                .then(res => res.json())
                .then(json => {
                    if (!json.routes || !json.routes[0]) return;
                    const coords = json.routes[0].geometry.coordinates; // [lon, lat]
                    const latLngs = coords.map(([lon, lat]) => [lat, lon]);
                    roads[roadKey] = latLngs;
                    L.polyline(latLngs, { color: 'blue', weight: 5 }).addTo(map);
                })
                .catch(err => {
                    console.error('Failed to load route for', roadKey, err);
                });
        }

        Object.keys(roadEndpoints).forEach(loadRoadRoute);

        // Mark key traffic-light-controlled junctions entering and leaving the CBD
        const trafficLightIntersections = [
            { coords: [-1.2870, 36.8129], label: 'Kenyatta Ave / Uhuru Hwy (CBD entry)' },
            { coords: [-1.2870, 36.8228], label: 'Kenyatta Ave / Moi Ave (CBD core)' },
            { coords: [-1.2888, 36.8210], label: 'Moi Ave / Haile Selassie (CBD exit)' },
            { coords: [-1.2820, 36.8140], label: 'University Way / Uhuru Hwy (CBD entry)' }
        ];

        trafficLightIntersections.forEach(tl => {
            L.circleMarker(tl.coords, {
                radius: 6,
                color: '#ff0000',
                fillColor: '#ffff00',
                fillOpacity: 0.9
            }).addTo(map).bindPopup(tl.label);
        });

        let cars = [];
        let stopCarsAtLight = false;

        function addCars() {
            const selectedRoad = document.getElementById('roadSelect').value;
            const numCars = parseInt(document.getElementById('carCount').value);
            const roadPoints = roads[selectedRoad];

            if (!roadPoints) {
                alert('Still loading the real Nairobi road path for this road. Please wait a moment and try again.');
                return;
            }

            for (let i = 0; i < numCars; i++) {
                const carMarker = L.circleMarker(roadPoints[0], { radius: 5, color: randomColor() }).addTo(map);
                cars.push({
                    marker: carMarker,
                    route: roadPoints,
                    position: 0, // Start at the beginning of the road
                    speed: Math.random() * 0.0005 + 0.0001 // Random speed
                });
            }

            animateCars();
        }

        function randomColor() {
            const colors = ['red', 'blue', 'green', 'yellow', 'purple'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function removeCars() {
            cars.forEach((car) => {
                map.removeLayer(car.marker);
            });
            cars = [];
        }

        function animateCars() {
            cars.forEach((car) => {
                const route = car.route;
                const numSegments = route.length - 1;
                if (numSegments <= 0) return;

                if (car.position < 1) {
                    const totalProgress = car.position * numSegments;
                    const segIndex = Math.min(Math.floor(totalProgress), numSegments - 1);
                    const localT = totalProgress - segIndex;

                    const start = route[segIndex];
                    const end = route[segIndex + 1];

                    const lat = start[0] + localT * (end[0] - start[0]);
                    const lon = start[1] + localT * (end[1] - start[1]);

                    car.marker.setLatLng([lat, lon]);
                    car.position += car.speed;

                    if (stopCarsAtLight && car.position > 0.5) {
                        car.position -= car.speed; // Pause cars near the traffic light
                    }
                }
            });

            requestAnimationFrame(animateCars);
        }

        function stopCars() {
            stopCarsAtLight = true;
        }

        function continueCars() {
            stopCarsAtLight = false;
        }

        let trafficLightState = 'red';
        function toggleTrafficLights() {
            trafficLightState = trafficLightState === 'red' ? 'green' : 'red';
            alert('Traffic light is now ' + trafficLightState);
            if (trafficLightState === 'green') {
                continueCars();
            }
        }
    </script>
</body>

</html>
